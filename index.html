<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extracción de fallas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #1a3c5e;
      --accent: #e84545;
      --light-bg: #f4f7fb;
    }
    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      padding-bottom: 20px;
    }
    .app-header {
      background: linear-gradient(135deg, var(--primary), #2a5f8f);
      color: white;
      padding: 1.2rem 1rem 1rem;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .app-header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
    }
    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .form-label {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--primary);
      margin-bottom: 0.2rem;
    }
    .form-control, .form-select {
      border-radius: 10px;
      border: 1.5px solid #dce3ef;
      font-size: 0.95rem;
    }
    .btn-submit {
      background: linear-gradient(135deg, var(--accent), #c0392b);
      border: none;
      border-radius: 12px;
      font-weight: 700;
      padding: 0.7rem;
    }
    .btn-success-custom {
      background: linear-gradient(135deg, #2a5f8f, #1a3c5e);
      border: none;
      border-radius: 12px;
      font-weight: 700;
      padding: 0.7rem;
    }
    .section-badge {
      display: inline-block;
      background: var(--primary);
      color: white;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    #customFallaWrapper {
      display: none;
    }
    .historial-item {
      background: white;
      border-radius: 12px;
      padding: 10px 14px;
      margin-bottom: 10px;
      border-left: 5px solid var(--accent);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      font-size: 0.9rem;
    }
    .linea-superior {
      display: flex;
      gap: 12px;
      font-weight: 600;
      color: var(--primary);
      flex-wrap: wrap;
    }
    .linea-inferior {
      display: flex;
      gap: 12px;
      color: #2c3e50;
      flex-wrap: wrap;
      align-items: baseline;
    }
    .badge-falla {
      background: #eef2f6;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--primary);
    }
    .fecha-hora {
      font-family: 'Courier New', monospace;
      background: #f0f3f8;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.75rem;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      width: 90%;
      max-width: 420px;
    }
  </style>
</head>
<body>

<div class="app-header">
  <h1><i class="bi bi-exclamation-triangle-fill me-2"></i>Extracción de fallas</h1>
</div>

<!-- Toast para mensajes -->
<div class="toast-container">
  <div id="toast" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body fw-semibold" id="toastMsg"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<div class="container py-2 px-3" style="max-width: 560px;">

  <!-- formulario de captura -->
  <div class="card p-3 mb-4">
    <form id="faultForm" novalidate>

      <span class="section-badge"><i class="bi bi-pencil-fill me-1"></i>Nueva falla</span>

      <!-- Tipo falla -->
      <div class="mb-2">
        <label class="form-label">Tipo de falla</label>
        <select class="form-select" id="tipo_falla" required>
          <option value="" disabled selected>— Seleccionar —</option>
          <option>Missing</option>
          <option>Extra Addr</option>
          <option>Fault</option>
          <option>Extra Addr No Device</option>
          <option>WRONG TYPE</option>
          <option>NODE MSNG</option>
          <option>NETWK FLT</option>
          <option>Otros</option>
        </select>
        <div id="customFallaWrapper" class="mt-2">
          <input type="text" class="form-control" id="falla_custom" placeholder="Especificar falla..." maxlength="100" />
        </div>
      </div>

      <!-- Dispositivo -->
      <div class="mb-2">
        <label class="form-label">Dispositivo</label>
        <select class="form-select" id="dispositivo" required>
          <option value="" disabled selected>— Seleccionar —</option>
          <option>Photo Detector</option>
          <option>Photo/Heat Detector</option>
          <option>Manual Stations</option>
          <option>Nac Aom NS</option>
          <option>FORM C AOM NS</option>
          <option>Supervisory Sw</option>
          <option>Waterflow Sil</option>
          <option>N.O. Contacts</option>
          <option>Trbl Ack Sw</option>
        </select>
      </div>

      <!-- Sitio y Nodo -->
      <div class="row g-2 mb-2">
        <div class="col-7">
          <label class="form-label">Sitio</label>
          <input type="text" class="form-control" id="sitio" placeholder="Ej: Edificio Central" maxlength="80" required />
        </div>
        <div class="col-5">
          <label class="form-label">Nodo (1-64)</label>
          <input type="number" class="form-control" id="nodo" placeholder="01" min="1" max="64" required />
        </div>
      </div>

      <!-- Laso y Fecha + Hora -->
      <div class="row g-2 mb-3">
        <div class="col-4">
          <label class="form-label">Laso</label>
          <div class="d-flex gap-3 mt-1">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="laso" id="lasoL1" value="L1" required />
              <label class="form-check-label fw-semibold" for="lasoL1">L1</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="laso" id="lasoL2" value="L2" />
              <label class="form-check-label fw-semibold" for="lasoL2">L2</label>
            </div>
          </div>
        </div>
        <div class="col-8">
          <label class="form-label">Fecha y hora</label>
          <input type="datetime-local" class="form-control" id="fecha_hora" required />
        </div>
      </div>

      <!-- BOTÓN 1: Agregar al historial (solo local) -->
      <button type="button" class="btn btn-submit btn-danger w-100 text-white mb-2" id="btnAgregarHistorial">
        <i class="bi bi-plus-circle-fill me-2"></i>Agregar al historial
      </button>
    </form>
  </div>

  <!-- HISTORIAL DE FALLAS -->
  <div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="section-badge"><i class="bi bi-clock-history me-1"></i>Últimas fallas</span>
      <span class="text-muted small" id="contadorFallas">0 registros</span>
    </div>
    <div id="historialContainer" style="max-height: 300px; overflow-y: auto;">
      <p class="text-muted text-center small py-3" id="sinFallasMsg">Aún no hay fallas registradas</p>
    </div>
  </div>

  <!-- BOTÓN 2: Enviar lista a Google Sheets -->
  <button class="btn btn-success-custom w-100 text-white mb-2" id="btnEnviarLista">
    <i class="bi bi-send-fill me-2"></i>Enviar lista a Google Sheets
  </button>

  <p class="text-center text-muted mt-2" style="font-size:0.7rem;">
    <i class="bi bi-shield-check me-1"></i>Las fallas se guardan localmente hasta que las envías
  </p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function() {
    // Elementos del formulario
    const tipoFalla = document.getElementById('tipo_falla');
    const customWrapper = document.getElementById('customFallaWrapper');
    const fallaCustom = document.getElementById('falla_custom');
    const sitio = document.getElementById('sitio');
    const nodo = document.getElementById('nodo');
    const dispositivo = document.getElementById('dispositivo');
    const lasoRadios = document.getElementsByName('laso');
    const fechaHora = document.getElementById('fecha_hora');

    // Botones
    const btnAgregar = document.getElementById('btnAgregarHistorial');
    const btnEnviar = document.getElementById('btnEnviarLista');

    // Contenedor historial
    const historialContainer = document.getElementById('historialContainer');
    const contadorSpan = document.getElementById('contadorFallas');

    // Array de fallas (storage)
    let fallas = [];

    // Toast
    function showToast(msg, success) {
      const toastEl = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      toastEl.classList.remove('bg-success', 'bg-danger');
      toastEl.classList.add(success ? 'bg-success' : 'bg-danger', 'text-white');
      toastMsg.textContent = msg;
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
    }

    // Cargar del localStorage
    function cargarFallas() {
      const stored = localStorage.getItem('fallasExtraccion');
      if (stored) {
        try {
          fallas = JSON.parse(stored);
        } catch (e) {
          fallas = [];
        }
      } else {
        fallas = [];
      }
      renderizarHistorial();
    }

    // Guardar en localStorage
    function guardarFallas() {
      localStorage.setItem('fallasExtraccion', JSON.stringify(fallas));
      renderizarHistorial();
    }

    // Formatear fecha
    function formatearFechaHora(datetimeStr) {
      if (!datetimeStr) return '—';
      const [fecha, hora] = datetimeStr.split('T');
      const [yyyy, mm, dd] = fecha.split('-');
      return `${dd}/${mm}/${yyyy.slice(2)} ${hora}`;
    }

    // Renderizar historial
    function renderizarHistorial() {
      if (fallas.length === 0) {
        historialContainer.innerHTML = `<p class="text-muted text-center small py-3">Aún no hay fallas registradas</p>`;
        contadorSpan.innerText = '0 registros';
        return;
      }

      const fallasOrdenadas = [...fallas].sort((a, b) => {
        if (a.fechaHora < b.fechaHora) return 1;
        if (a.fechaHora > b.fechaHora) return -1;
        return 0;
      });

      let html = '';
      fallasOrdenadas.forEach((f, index) => {
        const tipoMostrar = f.tipoFalla === 'Otros' ? f.fallaCustom : f.tipoFalla;
        const fechaFormateada = formatearFechaHora(f.fechaHora);

        html += `
          <div class="historial-item" data-index="${index}">
            <div class="linea-superior">
              <span><i class="bi bi-hdd-stack-fill me-1"></i>Nodo ${f.nodo.toString().padStart(2,'0')}</span>
              <span><i class="bi bi-geo-alt-fill me-1"></i>${f.sitio}</span>
            </div>
            <div class="linea-inferior mt-1">
              <span class="badge-falla">${tipoMostrar}</span>
              <span>${f.dispositivo}</span>
              <span>${f.laso}</span>
              <span class="fecha-hora"><i class="bi bi-clock me-1"></i>${fechaFormateada}</span>
            </div>
          </div>
        `;
      });

      historialContainer.innerHTML = html;
      contadorSpan.innerText = `${fallas.length} ${fallas.length === 1 ? 'registro' : 'registros'}`;
    }

    // Validar y agregar nueva falla al historial
    function agregarAlHistorial() {
      // Validaciones
      if (!tipoFalla.value) { showToast('Selecciona tipo de falla', false); return; }
      if (!dispositivo.value) { showToast('Selecciona dispositivo', false); return; }
      if (!sitio.value.trim()) { showToast('Sitio es obligatorio', false); return; }
      if (!nodo.value || nodo.value < 1 || nodo.value > 64) { showToast('Nodo debe ser entre 1 y 64', false); return; }
      
      let lasoSeleccionado = null;
      for (let radio of lasoRadios) {
        if (radio.checked) { lasoSeleccionado = radio.value; break; }
      }
      if (!lasoSeleccionado) { showToast('Selecciona L1 o L2', false); return; }
      if (!fechaHora.value) { showToast('Selecciona fecha y hora', false); return; }

      // Tipo falla (custom si es Otros)
      let tipoFinal = tipoFalla.value;
      let fallaCustomValue = '';
      if (tipoFalla.value === 'Otros') {
        if (!fallaCustom.value.trim()) { showToast('Especifica el tipo de falla (Otros)', false); return; }
        fallaCustomValue = fallaCustom.value.trim();
      }

      const nuevaFalla = {
        tipoFalla: tipoFinal,
        fallaCustom: fallaCustomValue,
        dispositivo: dispositivo.value,
        sitio: sitio.value.trim(),
        nodo: parseInt(nodo.value, 10),
        laso: lasoSeleccionado,
        fechaHora: fechaHora.value,
      };

      fallas.push(nuevaFalla);
      guardarFallas();
      showToast('Falla agregada al historial', true);

      // Reset formulario
      form.reset();
      customWrapper.style.display = 'none';
      fallaCustom.required = false;

      // Dejar fecha/hora con valor por defecto (ahora)
      setFechaHoraNow();
    }

    // Enviar lista a Google Sheets
    async function enviarLista() {
      if (fallas.length === 0) {
        showToast('No hay fallas para enviar', false);
        return;
      }

      // Deshabilitar botón mientras envía
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';

      try {
        // AQUÍ DEBES PONER TU URL DE GOOGLE SHEETS
        const response = await fetch('https://tu-url-de-google-sheets.com', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fallas: fallas })
        });

        if (response.ok) {
          showToast('Lista enviada correctamente a Google Sheets', true);
          // Limpiar historial después de enviar
          fallas = [];
          guardarFallas();
        } else {
          showToast('Error al enviar. Intenta de nuevo.', false);
        }
      } catch (error) {
        showToast('Error de conexión. Verifica tu URL.', false);
        console.error(error);
      } finally {
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = '<i class="bi bi-send-fill me-2"></i>Enviar lista a Google Sheets';
      }
    }

    // Inicializar fecha/hora actual
    function setFechaHoraNow() {
      const ahora = new Date();
      const año = ahora.getFullYear();
      const mes = String(ahora.getMonth() + 1).padStart(2, '0');
      const dia = String(ahora.getDate()).padStart(2, '0');
      const horas = String(ahora.getHours()).padStart(2, '0');
      const minutos = String(ahora.getMinutes()).padStart(2, '0');
      fechaHora.value = `${año}-${mes}-${dia}T${horas}:${minutos}`;
    }

    // Referencia al form para reset
    const form = document.getElementById('faultForm');

    // Evento para mostrar campo "Otros"
    tipoFalla.addEventListener('change', () => {
      if (tipoFalla.value === 'Otros') {
        customWrapper.style.display = 'block';
        fallaCustom.required = true;
      } else {
        customWrapper.style.display = 'none';
        fallaCustom.required = false;
        fallaCustom.value = '';
      }
    });

    // Evento botón Agregar al historial
    btnAgregar.addEventListener('click', agregarAlHistorial);

    // Evento botón Enviar lista
    btnEnviar.addEventListener('click', enviarLista);

    // Al cargar la página
    cargarFallas();
    setFechaHoraNow();
  })();
</script>
</body>
</html>