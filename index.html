<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ExtracciÃ³n de fallas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #1a3c5e;
      --accent: #e84545;
      --light-bg: #f4f7fb;
    }
    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      padding-bottom: 20px;
    }
    .app-header {
      background: linear-gradient(135deg, var(--primary), #2a5f8f);
      color: white;
      padding: 1.2rem 1rem 1rem;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .app-header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
    }
    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .form-label {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--primary);
      margin-bottom: 0.2rem;
    }
    .form-control, .form-select {
      border-radius: 10px;
      border: 1.5px solid #dce3ef;
      font-size: 0.95rem;
    }
    .btn-submit {
      background: linear-gradient(135deg, var(--accent), #c0392b);
      border: none;
      border-radius: 12px;
      font-weight: 700;
      padding: 0.7rem;
    }
    .btn-success-custom {
      background: linear-gradient(135deg, #2a5f8f, #1a3c5e);
      border: none;
      border-radius: 12px;
      font-weight: 700;
      padding: 0.7rem;
    }
    .section-badge {
      display: inline-block;
      background: var(--primary);
      color: white;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    #customFallaWrapper {
      display: none;
    }
    .historial-item {
      background: white;
      border-radius: 12px;
      padding: 10px 14px;
      margin-bottom: 10px;
      border-left: 5px solid var(--accent);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      font-size: 0.9rem;
    }
    .linea-superior {
      display: flex;
      gap: 12px;
      font-weight: 600;
      color: var(--primary);
      flex-wrap: wrap;
    }
    .linea-inferior {
      display: flex;
      gap: 12px;
      color: #2c3e50;
      flex-wrap: wrap;
      align-items: baseline;
    }
    .badge-falla {
      background: #eef2f6;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--primary);
    }
    .fecha-hora {
      font-family: 'Courier New', monospace;
      background: #f0f3f8;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.75rem;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      width: 90%;
      max-width: 420px;
    }
    .punto-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .punto-group select {
      width: 70px;
    }
    .punto-group input {
      flex: 1;
    }
    .email-form {
      display: inline;
    }
  </style>
</head>
<body>

<div class="app-header">
  <h1><i class="bi bi-exclamation-triangle-fill me-2"></i>ExtracciÃ³n de fallas</h1>
</div>

<!-- Toast para mensajes -->
<div class="toast-container">
  <div id="toast" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body fw-semibold" id="toastMsg"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<div class="container py-2 px-3" style="max-width: 560px;">

  <!-- formulario de captura -->
  <div class="card p-3 mb-4">
    <form id="faultForm" novalidate>

      <span class="section-badge"><i class="bi bi-pencil-fill me-1"></i>Nueva falla</span>

      <!-- Tipo falla -->
      <div class="mb-2">
        <label class="form-label">Tipo de falla</label>
        <select class="form-select" id="tipo_falla" required>
          <option value="" disabled selected>â€” Seleccionar â€”</option>
          <option>Missing</option>
          <option>Extra Addr</option>
          <option>Fault</option>
          <option>Extra Addr No Device</option>
          <option>WRONG TYPE</option>
          <option>NODE MSNG</option>
          <option>NETWK FLT</option>
          <option>Otros</option>
        </select>
        <div id="customFallaWrapper" class="mt-2">
          <input type="text" class="form-control" id="falla_custom" placeholder="Especificar falla..." maxlength="100" />
        </div>
      </div>

      <!-- Dispositivo -->
      <div class="mb-2">
        <label class="form-label">Dispositivo</label>
        <select class="form-select" id="dispositivo" required>
          <option value="" disabled selected>â€” Seleccionar â€”</option>
          <option>Photo Detector</option>
          <option>Photo/Heat Detector</option>
          <option>Manual Stations</option>
          <option>Nac Aom NS</option>
          <option>FORM C AOM NS</option>
          <option>Supervisory Sw</option>
          <option>Waterflow Sil</option>
          <option>N.O. Contacts</option>
          <option>Trbl Ack Sw</option>
        </select>
      </div>

      <!-- Sitio y Nodo -->
      <div class="row g-2 mb-2">
        <div class="col-7">
          <label class="form-label">Sitio</label>
          <input type="text" class="form-control" id="sitio" placeholder="Ej: Edificio Central" maxlength="80" required />
        </div>
        <div class="col-5">
          <label class="form-label">Nodo (1-64)</label>
          <input type="number" class="form-control" id="nodo" placeholder="01" min="1" max="64" required />
        </div>
      </div>

      <!-- Punto: M / S + nÃºmero -->
      <div class="mb-2">
        <label class="form-label">Punto</label>
        <div class="punto-group">
          <select class="form-select" id="punto_tipo" required>
            <option value="M">M (MÃ³dulo)</option>
            <option value="S">S (Sensor)</option>
          </select>
          <input type="number" class="form-control" id="punto_num" placeholder="000-159" min="0" max="159" step="1" required />
        </div>
        <div class="nodo-label-hint mt-1">Valor entre 000 y 159</div>
      </div>

      <!-- LAZO y Fecha + Hora -->
      <div class="row g-2 mb-3">
        <div class="col-4">
          <label class="form-label">Lazo</label>
          <div class="d-flex gap-3 mt-1">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="lazo" id="lazoL1" value="L1" required />
              <label class="form-check-label fw-semibold" for="lazoL1">L1</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="lazo" id="lazoL2" value="L2" />
              <label class="form-check-label fw-semibold" for="lazoL2">L2</label>
            </div>
          </div>
        </div>
        <div class="col-8">
          <label class="form-label">Fecha y hora</label>
          <input type="datetime-local" class="form-control" id="fecha_hora" required />
        </div>
      </div>

      <!-- BOTÃ“N 1: Agregar al historial -->
      <button type="button" class="btn btn-submit btn-danger w-100 text-white mb-2" id="btnAgregarHistorial">
        <i class="bi bi-plus-circle-fill me-2"></i>Agregar al historial
      </button>
    </form>
  </div>

  <!-- HISTORIAL DE FALLAS -->
  <div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="section-badge"><i class="bi bi-clock-history me-1"></i>Ãšltimas fallas</span>
      <span class="text-muted small" id="contadorFallas">0 registros</span>
    </div>
    <div id="historialContainer" style="max-height: 300px; overflow-y: auto;">
      <p class="text-muted text-center small py-3">AÃºn no hay fallas registradas</p>
    </div>
  </div>

  <!-- BOTÃ“N 2: Enviar por correo a mdmpgc@gmail.com -->
  <form id="emailForm" action="https://formsubmit.co/mdmpgc@gmail.com" method="POST" target="_blank" class="email-form">
    <input type="hidden" name="_subject" value="ðŸ“‹ Reporte de Fallas">
    <input type="hidden" name="_template" value="table">
    <input type="hidden" name="_captcha" value="false">
    <input type="hidden" name="_next" value="https://formsubmit.co/gracias">
    <input type="hidden" name="datos_fallas" id="datosFallasInput" value="">
    
    <button type="submit" class="btn btn-success-custom w-100 text-white mb-2" id="btnEnviarEmail">
      <i class="bi bi-envelope-fill me-2"></i>Enviar por correo a mdmpgc@gmail.com
    </button>
  </form>

  <p class="text-center text-muted mt-2" style="font-size:0.7rem;">
    <i class="bi bi-shield-check me-1"></i>Datos en memoria, al recargar se reinician
  </p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function() {
    // Elementos del formulario
    const tipoFalla = document.getElementById('tipo_falla');
    const customWrapper = document.getElementById('customFallaWrapper');
    const fallaCustom = document.getElementById('falla_custom');
    const sitio = document.getElementById('sitio');
    const nodo = document.getElementById('nodo');
    const dispositivo = document.getElementById('dispositivo');
    const puntoTipo = document.getElementById('punto_tipo');
    const puntoNum = document.getElementById('punto_num');
    const lazoRadios = document.getElementsByName('lazo');
    const fechaHora = document.getElementById('fecha_hora');
    const form = document.getElementById('faultForm');
    const btnAgregar = document.getElementById('btnAgregarHistorial');
    const btnEnviarEmail = document.getElementById('btnEnviarEmail');
    const emailForm = document.getElementById('emailForm');
    const datosFallasInput = document.getElementById('datosFallasInput');
    const historialContainer = document.getElementById('historialContainer');
    const contadorSpan = document.getElementById('contadorFallas');

    // Array de fallas (solo en memoria)
    let fallas = [];

    // Mostrar mensaje
    function mostrarMensaje(texto, exito) {
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      toast.classList.remove('bg-success', 'bg-danger');
      toast.classList.add(exito ? 'bg-success' : 'bg-danger', 'text-white');
      toastMsg.textContent = texto;
      new bootstrap.Toast(toast).show();
    }

    // Formatear fecha
    function formatearFecha(fechaHoraStr) {
      if (!fechaHoraStr) return 'â€”';
      const [fecha, hora] = fechaHoraStr.split('T');
      const [y, m, d] = fecha.split('-');
      return `${d}/${m}/${y.slice(2)} ${hora}`;
    }

    // Actualizar historial
    function actualizarHistorial() {
      if (fallas.length === 0) {
        historialContainer.innerHTML = '<p class="text-muted text-center small py-3">AÃºn no hay fallas registradas</p>';
        contadorSpan.innerText = '0 registros';
        return;
      }

      const ordenadas = [...fallas].sort((a, b) => (a.fechaHora < b.fechaHora ? 1 : -1));

      let html = '';
      ordenadas.forEach(f => {
        const tipoFinal = f.tipoFalla === 'Otros' ? f.fallaCustom : f.tipoFalla;
        const puntoFinal = `${f.puntoTipo}${String(f.puntoNum).padStart(3, '0')}`;
        
        html += `
          <div class="historial-item">
            <div class="linea-superior">
              <span><i class="bi bi-hdd-stack-fill me-1"></i>Nodo ${String(f.nodo).padStart(2, '0')}</span>
              <span><i class="bi bi-geo-alt-fill me-1"></i>${f.sitio}</span>
            </div>
            <div class="linea-inferior mt-1">
              <span class="badge-falla">${tipoFinal}</span>
              <span>${f.dispositivo}</span>
              <span><strong>${puntoFinal}</strong></span>
              <span>${f.lazo}</span>
              <span class="fecha-hora"><i class="bi bi-clock me-1"></i>${formatearFecha(f.fechaHora)}</span>
            </div>
          </div>
        `;
      });

      historialContainer.innerHTML = html;
      contadorSpan.innerText = `${fallas.length} ${fallas.length === 1 ? 'registro' : 'registros'}`;
    }

    // Agregar falla
    function agregarFalla() {
      if (!tipoFalla.value) { mostrarMensaje('Selecciona tipo de falla', false); return; }
      if (!dispositivo.value) { mostrarMensaje('Selecciona dispositivo', false); return; }
      if (!sitio.value.trim()) { mostrarMensaje('Escribe el sitio', false); return; }
      if (!nodo.value || nodo.value < 1 || nodo.value > 64) { mostrarMensaje('Nodo debe ser 1-64', false); return; }
      if (!puntoNum.value || puntoNum.value < 0 || puntoNum.value > 159) { mostrarMensaje('Punto debe ser 000-159', false); return; }
      
      let lazoSeleccionado = null;
      for (let radio of lazoRadios) {
        if (radio.checked) { lazoSeleccionado = radio.value; break; }
      }
      if (!lazoSeleccionado) { mostrarMensaje('Selecciona L1 o L2', false); return; }
      if (!fechaHora.value) { mostrarMensaje('Selecciona fecha y hora', false); return; }

      let tipoFinal = tipoFalla.value;
      let customValue = '';
      if (tipoFalla.value === 'Otros') {
        if (!fallaCustom.value.trim()) { mostrarMensaje('Especifica el tipo de falla', false); return; }
        customValue = fallaCustom.value.trim();
      }

      const nuevaFalla = {
        tipoFalla: tipoFinal,
        fallaCustom: customValue,
        dispositivo: dispositivo.value,
        sitio: sitio.value.trim(),
        nodo: parseInt(nodo.value),
        puntoTipo: puntoTipo.value,
        puntoNum: parseInt(puntoNum.value),
        lazo: lazoSeleccionado,
        fechaHora: fechaHora.value
      };

      fallas.push(nuevaFalla);
      actualizarHistorial();
      mostrarMensaje('âœ… Falla agregada', true);

      // Reset
      form.reset();
      customWrapper.style.display = 'none';
      puntoTipo.value = 'M';
      
      // Reset fecha/hora
      const ahora = new Date();
      const aÃ±o = ahora.getFullYear();
      const mes = String(ahora.getMonth() + 1).padStart(2, '0');
      const dia = String(ahora.getDate()).padStart(2, '0');
      const horas = String(ahora.getHours()).padStart(2, '0');
      const minutos = String(ahora.getMinutes()).padStart(2, '0');
      fechaHora.value = `${aÃ±o}-${mes}-${dia}T${horas}:${minutos}`;
    }

    // Preparar datos para el correo
    function prepararDatosParaEmail() {
      if (fallas.length === 0) {
        mostrarMensaje('No hay fallas para enviar', false);
        return false;
      }

      // Crear un texto con todas las fallas
      let textoFallas = "ðŸ“‹ REPORTE DE FALLAS\n\n";
      fallas.forEach((f, index) => {
        const tipoFinal = f.tipoFalla === 'Otros' ? f.fallaCustom : f.tipoFalla;
        const puntoFinal = `${f.puntoTipo}${String(f.puntoNum).padStart(3, '0')}`;
        
        textoFallas += `--- FALLA ${index + 1} ---\n`;
        textoFallas += `Tipo: ${tipoFinal}\n`;
        textoFallas += `Dispositivo: ${f.dispositivo}\n`;
        textoFallas += `Sitio: ${f.sitio}\n`;
        textoFallas += `Nodo: ${f.nodo}\n`;
        textoFallas += `Punto: ${puntoFinal}\n`;
        textoFallas += `Lazo: ${f.lazo}\n`;
        textoFallas += `Fecha/Hora: ${formatearFecha(f.fechaHora)}\n\n`;
      });

      datosFallasInput.value = textoFallas;
      return true;
    }

    // Evento "Otros"
    tipoFalla.addEventListener('change', () => {
      if (tipoFalla.value === 'Otros') {
        customWrapper.style.display = 'block';
        fallaCustom.required = true;
      } else {
        customWrapper.style.display = 'none';
        fallaCustom.required = false;
        fallaCustom.value = '';
      }
    });

    // Evento Agregar
    btnAgregar.addEventListener('click', agregarFalla);
    form.addEventListener('submit', (e) => e.preventDefault());

    // Evento Enviar por correo
    btnEnviarEmail.addEventListener('click', (e) => {
      if (!prepararDatosParaEmail()) {
        e.preventDefault();
        return false;
      }
      // PequeÃ±a pausa para asegurar que el input se llenÃ³
      setTimeout(() => {
        emailForm.submit();
      }, 100);
    });

    // Inicializar fecha
    const ahora = new Date();
    const aÃ±o = ahora.getFullYear();
    const mes = String(ahora.getMonth() + 1).padStart(2, '0');
    const dia = String(ahora.getDate()).padStart(2, '0');
    const horas = String(ahora.getHours()).padStart(2, '0');
    const minutos = String(ahora.getMinutes()).padStart(2, '0');
    fechaHora.value = `${aÃ±o}-${mes}-${dia}T${horas}:${minutos}`;

    actualizarHistorial();
  })();
</script>
</body>
</html>
